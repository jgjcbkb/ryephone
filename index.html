
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="点九编辑器">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>点九编辑器</title>
    <style>
        :root {
            --stretch-color: #3498db; --content-color: #2ecc71; --bg-color: #f0f2f5;
            --panel-color: #ffffff; --text-color: #333; --touch-threshold: 22px;
            --ai-color: #8e44ad; --user-color: #e67e22;
        }
        * { box-sizing: border-box; }
        html, body { overscroll-behavior: none; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 0;
            display: flex; flex-direction: column; 
            height: 100dvh; 
            overflow: hidden;
        }
        .top-tabs {
            display: flex; background-color: var(--panel-color); box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .tab-btn {
            flex: 1; padding: 12px; text-align: center; background: none; border: none;
            font-size: 16px; font-weight: 500; color: #888; cursor: pointer;
            border-bottom: 3px solid transparent; transition: all 0.2s;
        }
        .tab-btn.active { color: var(--text-color); }
        .tab-btn[data-editor="ai"].active { border-bottom-color: var(--ai-color); }
        .tab-btn[data-editor="user"].active { border-bottom-color: var(--user-color); }
        .main-content {
            flex-grow: 1; display: flex; justify-content: center; align-items: center;
            overflow: auto; background-color: #7f8c8d; position: relative;
        }
        #canvas-wrapper { position: relative; touch-action: none; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        canvas {
            display: block;
            background-image: linear-gradient(45deg, #eee 25%, transparent 25%), linear-gradient(-45deg, #eee 25%, transparent 25%),
                              linear-gradient(45deg, transparent 75%, #eee 75%), linear-gradient(-45deg, transparent 75%, #eee 75%);
            background-size: 20px 20px; background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }
        .bottom-section {
            background-color: var(--bg-color); padding-top: 10px;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.05); flex-shrink: 0; overflow-y: auto; 
            padding-bottom: env(safe-area-inset-bottom);
            max-height: 45dvh;
        }
        .info-panel {
            background-color: var(--panel-color); margin: 0 10px 10px 10px;
            padding: 8px 15px; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.08);
        }
        .info-section h4 { margin: 5px 0; font-size: 14px; font-weight: 600; }
        .info-section:nth-of-type(2) h4 { color: var(--stretch-color); }
        .info-section:nth-of-type(3) h4 { color: var(--content-color); }
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 2px 10px; font-size: 13px; }
        .info-grid-item { display: flex; justify-content: space-between; align-items: center; }
        .info-grid-item .label { color: #666; }
        .info-grid-item .value { font-weight: 500; color: var(--text-color); }
        .control-panel { background-color: var(--panel-color); padding: 10px; border-top: 1px solid #eee; }
        .mode-selector { display: flex; justify-content: space-around; margin-bottom: 10px; }
        .mode-btn { background: none; border: none; padding: 10px; font-size: 16px; color: #888; cursor: pointer; position: relative; transition: color 0.2s; }
        .mode-btn.active { color: var(--text-color); font-weight: bold; }
        .mode-btn.active::after { content: ''; position: absolute; bottom: 0; left: 10px; right: 10px; height: 3px; border-radius: 1.5px; background-color: var(--stretch-color); }
        .mode-btn[data-mode="content"].active::after { background-color: var(--content-color); }
        .actions-wrapper { display: flex; flex-wrap: wrap; justify-content: space-around; align-items: center; gap: 10px; }
        .actions button, .actions label { display: flex; flex-direction: column; align-items: center; background: none; border: none; font-size: 12px; color: #555; padding: 5px; border-radius: 8px; width: 65px; text-align: center; cursor: pointer; }
        .actions button:disabled { color: #ccc; cursor: not-allowed; }
        .actions svg { width: 24px; height: 24px; margin-bottom: 4px; }
        #file-input-ai, #file-input-user { display: none; }
        
        .side-selector, .stretch-line-selector { display: flex; flex-direction: column; align-items: center; }
        .side-selector legend, .stretch-line-selector legend { font-size: 12px; margin-bottom: 5px; color: #555; font-weight: bold; }
        .side-options { display: flex; gap: 5px; }
        .side-options label { font-size: 12px; padding: 6px 10px; border: 1px solid #ddd; border-radius: 15px; cursor: pointer; transition: all 0.2s; }
        .side-options input { display: none; }
        .side-options input:checked + label { background-color: var(--stretch-color); color: white; border-color: var(--stretch-color); }
        .side-selector[disabled] { opacity: 0.5; pointer-events: none; }
        
        .stretch-line-options { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
        .stretch-line-options button { font-size: 12px; padding: 6px 10px; border: 1px solid #ddd; border-radius: 15px; cursor: pointer; transition: all 0.2s; background-color: #f5f5f5; }
        .stretch-line-options button.active { background-color: var(--stretch-color); color: white; border-color: var(--stretch-color); }
        #placeholder { color: #aaa; text-align: center; }
        #preview-window { display: none; position: fixed; bottom: 20px; right: 20px; width: 90%; max-width: 320px; background-color: var(--panel-color); border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); z-index: 100; overflow: hidden; }
        #preview-window-header { display: flex; justify-content: space-between; align-items: center; padding: 8px 15px; background-color: #f8f9fa; border-bottom: 1px solid #eee; }
        #preview-window-header h3 { margin: 0; font-size: 16px; }
        #preview-close-btn { background: none; border: none; font-size: 24px; font-weight: bold; color: #aaa; cursor: pointer; line-height: 1; padding: 0 5px; }
        #preview-window .content { padding: 15px; }
        #preview-container { display: flex; justify-content: center; align-items: center; min-height: 150px; margin-bottom: 15px; background-color: var(--bg-color); border-radius: 8px; overflow: auto; }
        #preview-box { position: relative; flex-shrink: 0; }
        #preview-content-area { position: absolute; display: none; background-color: rgba(46, 204, 113, 0.5); }
        #preview-content-area.visible { display: block; }
        .preview-controls { display: flex; flex-direction: column; gap: 10px; }
        .slider-group, .checkbox-group { display: flex; align-items: center; gap: 10px; font-size: 13px; }
        .slider-group label { flex-shrink: 0; width: 70px; }
        .slider-group input[type="range"] { flex-grow: 1; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-content { background-color: white; padding: 20px; border-radius: 12px; width: 90%; max-width: 500px; text-align: left; display: flex; flex-direction: column; max-height: 90vh; }
        .modal-content h3 { margin-top: 0; text-align: center; flex-shrink: 0; }
        .modal-body { overflow-y: auto; flex-grow: 1; padding-right: 10px; /* Add some padding for scrollbar */ }
        .modal-content .input-group { margin-bottom: 15px; }
        .modal-content label { display: block; margin-bottom: 5px; font-size: 14px; font-weight: 500; }
        .modal-content input, .modal-content textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; }
        .modal-content textarea { min-height: 60px; resize: vertical; }
        .modal-content .url-grid, .modal-content .color-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .modal-actions { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; flex-shrink: 0; }
        .modal-actions button { padding: 12px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; }
        .modal-actions .btn-primary { background-color: #2ecc71; color: white; }
        .modal-actions .btn-secondary { background-color: #3498db; color: white; }
        .modal-actions .btn-tertiary-group { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .modal-actions .btn-tertiary { background-color: #9b59b6; color: white; font-size: 12px; padding: 10px 5px; }
        #modal-close-btn { background-color: #e74c3c; color: white; margin-top: 10px; }
        
        #code-preview-view { display: none; flex-direction: column; height: 100%; }
        #code-preview-textarea { flex-grow: 1; width: 100%; min-height: 150px; resize: vertical; font-family: monospace; font-size: 12px; white-space: pre; }
        .code-preview-actions { display: flex; gap: 10px; margin-top: 15px; }
        .code-preview-actions button { flex: 1; }

        #download-options-view {
            display: flex;
            flex-direction: column;
            height: 100%; 
            overflow: hidden;
        }
        
    </style>
</head>
<body>
    <div class="top-tabs">
        <button class="tab-btn active" data-editor="ai">AI (左)</button>
        <button class="tab-btn" data-editor="user">User (右)</button>
    </div>
    <div class="main-content">
        <div id="canvas-wrapper"><canvas id="editor-canvas"></canvas></div>
        <div id="placeholder"><h2>请为当前标签选择图片</h2><p>点击下方“打开”按钮开始</p></div>
    </div>
    <div class="bottom-section">
        <div class="info-panel" id="info-panel" style="display: none;"></div>
        <div class="control-panel">
            <div class="mode-selector"></div>
            <div class="actions-wrapper">
                <fieldset id="side-selector-fieldset" class="side-selector"></fieldset>
                <div class="stretch-line-selector" id="stretch-line-controls" style="display: none;">
                    <legend>拉伸线</legend>
                    <div class="stretch-line-options">
                        <button class="line-control-btn" data-line="top">上/下</button>
                        <button class="line-control-btn" data-line="left">左/右</button>
                    </div>
                </div>
                <div class="actions"></div>
            </div>
        </div>
    </div>
    <div id="preview-window">
        <div id="preview-window-header"><h3>拉伸预览</h3><button id="preview-close-btn">&times;</button></div>
        <div class="content">
            <div id="preview-container"><div id="preview-box"><div id="preview-content-area"></div></div></div>
            <div class="preview-controls">
                <div class="slider-group"><label for="width-slider">左右拉伸:</label><input type="range" id="width-slider" min="50" max="500" value="150"></div>
                <div class="slider-group"><label for="height-slider">上下拉伸:</label><input type="range" id="height-slider" min="50" max="500" value="100"></div>
                <div class="checkbox-group"><input type="checkbox" id="show-content-checkbox"><label for="show-content-checkbox">显示内容区域</label></div>
            </div>
        </div>
    </div>
    <div id="download-modal" class="modal"></div>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const canvas = document.getElementById('editor-canvas'); const ctx = canvas.getContext('2d');
        const placeholder = document.getElementById('placeholder'); const infoPanel = document.getElementById('info-panel');
        const previewWindow = document.getElementById('preview-window'); const previewBox = document.getElementById('preview-box');
        const previewContentArea = document.getElementById('preview-content-area');
        const widthSlider = document.getElementById('width-slider'); const heightSlider = document.getElementById('height-slider');
        const showContentCheckbox = document.getElementById('show-content-checkbox');
        const modal = document.getElementById('download-modal');
        const stretchLineControls = document.getElementById('stretch-line-controls');
        const sideSelectorFieldset = document.getElementById('side-selector-fieldset');
        document.querySelector('.mode-selector').innerHTML = `<button class="mode-btn active" data-mode="stretch">拉伸区域</button><button class="mode-btn" data-mode="content">内容区域</button>`;
        sideSelectorFieldset.innerHTML = `<legend>图片位置</legend><div class="side-options"><input type="radio" id="side-left" name="side" value="left" checked><label for="side-left">左侧</label><input type="radio" id="side-center" name="side" value="center"><label for="side-center">中间</label><input type="radio" id="side-right" name="side" value="right"><label for="side-right">右侧</label></div>`;
        document.querySelector('.actions').innerHTML = `<label id="open-file-label" for="file-input-ai"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>打开</label><input type="file" id="file-input-ai" accept="image/*"><input type="file" id="file-input-user" accept="image/*"><button id="url-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>URL</button><button id="clear-btn" disabled><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>重置</button><button id="toggle-preview-btn" disabled><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>预览</button><button id="download-trigger-btn" disabled><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>下载</button>`;
        
        modal.innerHTML = `<div class="modal-content">
            <div id="download-options-view">
                <h3>下载选项</h3>
                <div class="modal-body">
                    <div class="url-grid">
                        <div class="input-group" id="ai-url-group"><label for="ai-url-input">AI 图片 URL:</label><input type="url" id="ai-url-input" placeholder="AI 图片链接"></div>
                        <div class="input-group" id="user-url-group"><label for="user-url-input">User 图片 URL:</label><input type="url" id="user-url-input" placeholder="User 图片链接"></div>
                    </div>
                    <div class="color-grid">
                        <div class="input-group"><label for="ai-color-input">AI文字颜色:</label><input type="text" id="ai-color-input" value="#000000"></div>
                        <div class="input-group"><label for="user-color-input">User文字颜色:</label><input type="text" id="user-color-input" value="#000000"></div>
                    </div>

                    <!-- START: 新增的功能 -->
                    <div class="input-group">
                        <label>气泡应用模式:</label>
                        <div style="display: flex; gap: 20px; padding-top: 5px;">
                            <label><input type="radio" name="bubble-mode" value="all" checked> 全部使用气泡</label>
                            <label><input type="radio" name="bubble-mode" value="text-only"> 仅文本/语音使用</label>
                        </div>
                    </div>
                    <!-- END: 新增的功能 -->

                    <div class="input-group"><label for="scale-factor-input">缩放比例 (SF):</label>
<input type="number" id="scale-factor-input" value="18" min="1" step="0.1" placeholder="例如: 18"></div>
                    <div class="input-group"><label for="left-text-input">左侧演示文字:</label><textarea id="left-text-input">这是一条来自左边的长消息。</textarea></div>
                    <div class="input-group"><label for="right-text-input">右侧演示文字:</label><textarea id="right-text-input">这是一条来自右边的长消息。</textarea></div>
                </div>
                <div class="modal-actions">
                    <div class="btn-tertiary-group"><button data-target="receiver" class="btn-tertiary css-preview-trigger">下载接收方</button><button data-target="sender" class="btn-tertiary css-preview-trigger">下载发送方</button><button data-target="global" class="btn-tertiary css-preview-trigger">下载全局</button></div>
                    <div class="btn-tertiary-group" style="margin-top: -5px; margin-bottom: 5px;"><button data-target="ai" class="btn-tertiary css-preview-trigger">下载 AI 样式</button><button data-target="user" class="btn-tertiary css-preview-trigger">下载 User 样式</button><button data-target="full" class="btn-tertiary css-preview-trigger">下载合并样式</button></div>
                    <button id="download-code-btn" class="btn-primary">下载演示代码 (.html)</button>
                    <button id="download-image-btn" class="btn-secondary">下载图片 (.9.png)</button>
                    <button id="modal-close-btn">取消</button>
                </div>
            </div>
            <div id="code-preview-view">
                <h3 id="code-preview-title">代码预览</h3>
                <textarea id="code-preview-textarea" readonly></textarea>
                <div class="code-preview-actions">
                    <button id="copy-code-btn" class="btn-primary">复制</button>
                    <button id="download-file-btn" class="btn-secondary">下载文件</button>
                    <button id="back-to-options-btn">返回</button>
                </div>
            </div>
        </div>`;
        infoPanel.innerHTML = `<div class="info-section"><div class="info-grid"><div class="info-grid-item"><span class="label">图像尺寸:</span><span class="value" id="img-size"></span></div></div></div><div class="info-section"><h4>拉伸区域 (px)</h4><div class="info-grid"><div class="info-grid-item"><span class="label">左/右:</span><span class="value" id="stretch-horiz"></span></div><div class="info-grid-item"><span class="label">上/下:</span><span class="value" id="stretch-vert"></span></div></div></div><div class="info-section"><h4>内容区域 (px)</h4><div class="info-grid"><div class="info-grid-item"><span class="label">左:</span><span class="value" id="content-left"></span></div><div class="info-grid-item"><span class="label">右:</span><span class="value" id="content-right"></span></div><div class="info-grid-item"><span class="label">上:</span><span class="value" id="content-top"></span></div><div class="info-grid-item"><span class="label">下:</span><span class="value" id="content-bottom"></span></div></div></div>`;

        let configurations = {
            ai: { image: null, regions: { stretch: { top: null, bottom: null, left: null, right: null }, content: {} }, fileName: '' },
            user: { image: null, regions: { stretch: { top: null, bottom: null, left: null, right: null }, content: {} }, fileName: '' }
        };
        let activeEditor = 'ai';
        let currentMode = 'stretch';
        let isDragging = false, draggingLine = null, scale = 1;
        const TOUCH_THRESHOLD = 22;
        const togglePreviewBtn = document.getElementById('toggle-preview-btn');

        function init() {
            document.getElementById('file-input-ai').addEventListener('change', (e) => handleFileSelect(e, 'ai'));
            document.getElementById('file-input-user').addEventListener('change', (e) => handleFileSelect(e, 'user'));
            document.getElementById('url-btn').addEventListener('click', () => handleUrlInput(activeEditor));
            document.getElementById('clear-btn').addEventListener('click', () => { if (!configurations[activeEditor].image) return; resetRegions(activeEditor, currentMode); setupPreview(configurations[activeEditor].image); redrawAll(); updateInfoPanel(); updatePreview(); });
            document.getElementById('download-trigger-btn').addEventListener('click', openDownloadModal);
            
            modal.addEventListener('click', (e) => {
                const target = e.target;
                if (target.id === 'modal-close-btn') {
                    modal.style.display = 'none';
                } else if (target.id === 'download-image-btn') {
                    downloadImage(activeEditor);
                } else if (target.id === 'download-code-btn') {
                    downloadCode();
                } else if (target.classList.contains('css-preview-trigger')) {
                    showCodePreview(target.dataset.target);
                } else if (target.id === 'back-to-options-btn') {
                    document.getElementById('code-preview-view').style.display = 'none';
                    document.getElementById('download-options-view').style.display = 'flex';
                }
            });

            document.querySelectorAll('.tab-btn').forEach(btn => btn.addEventListener('click', (e) => switchEditor(e.currentTarget.dataset.editor)));
            document.querySelectorAll('.mode-btn').forEach(btn => btn.addEventListener('click', (e) => { document.querySelector('.mode-btn.active').classList.remove('active'); e.currentTarget.classList.add('active'); currentMode = e.currentTarget.dataset.mode; stretchLineControls.style.display = currentMode === 'stretch' ? 'flex' : 'none'; drawCanvasContents(); }));
            togglePreviewBtn.addEventListener('click', () => previewWindow.style.display = 'block');
            document.getElementById('preview-close-btn').addEventListener('click', () => previewWindow.style.display = 'none');
            widthSlider.addEventListener('input', e => previewBox.style.width = `${e.target.value}px`);
            heightSlider.addEventListener('input', e => previewBox.style.height = `${e.target.value}px`);
            showContentCheckbox.addEventListener('change', e => previewContentArea.classList.toggle('visible', e.target.checked));
            const wrapper = document.getElementById('canvas-wrapper');
            const events = { down: ['mousedown', 'touchstart'], up: ['mouseup', 'touchend', 'touchcancel'], };
            events.down.forEach(e => wrapper.addEventListener(e, onDown, { passive: false }));
            window.addEventListener('mousemove', onMove, { passive: false });
            window.addEventListener('touchmove', onMove, { passive: false, capture: true });
            events.up.forEach(e => window.addEventListener(e, onUp, { passive: false }));
            stretchLineControls.addEventListener('click', (e) => { const btn = e.target.closest('.line-control-btn'); if (btn) { toggleStretchLine(btn.dataset.line); } });
        }

        function switchEditor(editor) { if (activeEditor === editor) return; activeEditor = editor; document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active')); document.querySelector(`.tab-btn[data-editor="${editor}"]`).classList.add('active'); document.getElementById('open-file-label').htmlFor = `file-input-${editor}`; updateEditorState(); }
        
        function handleFileSelect(e, editor) {
            const file = e.target.files[0]; if (!file) return;
            const config = configurations[editor];
            config.fileName = file.name;
            const reader = new FileReader();
            reader.onload = event => {
                const img = new Image();
                img.onload = () => {
                    config.image = img;
                    if (editor === activeEditor) {
                        updateEditorState();
                    }
                    sideSelectorFieldset.disabled = !!(configurations.ai.image && configurations.user.image);
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        function handleUrlInput(editor) {
            const url = prompt("请输入图片链接 (URL):");
            if (!url) return;
            
            // 自动填充下载选项中的 URL 字段
            if (editor === 'ai') document.getElementById('ai-url-input').value = url;
            if (editor === 'user') document.getElementById('user-url-input').value = url;

            const config = configurations[editor];
            config.fileName = url.substring(url.lastIndexOf('/') + 1) || 'image_from_url.png';
            
            const img = new Image();
            img.crossOrigin = "Anonymous"; // 关键：允许跨域，否则无法导出
            img.onload = () => {
                config.image = img;
                if (editor === activeEditor) {
                    updateEditorState();
                }
                sideSelectorFieldset.disabled = !!(configurations.ai.image && configurations.user.image);
            };
            img.onerror = () => {
                alert("加载图片失败。请确保 URL 正确，且服务器允许跨域访问 (CORS)。");
            };
            img.src = url;
        }

        function updateEditorState() { const config = configurations[activeEditor]; if (config.image) { placeholder.style.display = 'none'; canvas.style.display = 'block'; infoPanel.style.display = 'block'; stretchLineControls.style.display = currentMode === 'stretch' ? 'flex' : 'none'; document.getElementById('clear-btn').disabled = false; document.getElementById('toggle-preview-btn').disabled = false; document.getElementById('download-trigger-btn').disabled = false; setupCanvas(); if(!config.regions.content.top) { resetRegions(activeEditor, 'all'); } redrawAll(); updateInfoPanel(); setupPreview(config.image); updatePreview(); } else { canvas.style.display = 'none'; infoPanel.style.display = 'none'; stretchLineControls.style.display = 'none'; placeholder.style.display = 'block'; document.getElementById('clear-btn').disabled = true; document.getElementById('toggle-preview-btn').disabled = true; document.getElementById('download-trigger-btn').disabled = true; } }
        
        function onMove(e) { const config = configurations[activeEditor]; if (!isDragging || !draggingLine || !config.image) return; e.preventDefault(); const pos = getEventPos(e); const r = config.regions[currentMode]; const w = config.image.width; const h = config.image.height; if (draggingLine === 'top') r.top = Math.max(0, Math.min(pos.y, r.bottom ?? h)); else if (draggingLine === 'bottom') r.bottom = Math.min(h, Math.max(pos.y, r.top ?? 0)); else if (draggingLine === 'left') r.left = Math.max(0, Math.min(pos.x, r.right ?? w)); else if (draggingLine === 'right') r.right = Math.min(w, Math.max(pos.x, r.left ?? 0)); drawCanvasContents(); updateInfoPanel(); updatePreview(); }
        
        function toggleStretchLine(line) { const config = configurations[activeEditor]; if (!config.image) return; const w = config.image.width; const h = config.image.height; const s = config.regions.stretch; const isVertical = line === 'top'; const isHorizontal = line === 'left'; if ((isVertical && s.top !== null) || (isHorizontal && s.left !== null)) { if (isVertical) { s.top = s.bottom = null; } if (isHorizontal) { s.left = s.right = null; } } else { if (isVertical) { s.top = h * 0.25; s.bottom = h * 0.75; } if (isHorizontal) { s.left = w * 0.25; s.right = w * 0.75; } } redrawAll(); updateInfoPanel(); updatePreview(); }
        
        function setupPreview(image) { const maxPreviewDim = 280; let initialWidth, initialHeight; const ratio = image.width / image.height; if (ratio > 1) { initialWidth = Math.min(image.width, maxPreviewDim); initialHeight = initialWidth / ratio; } else { initialHeight = Math.min(image.height, maxPreviewDim); initialWidth = initialHeight * ratio; } initialWidth = Math.round(initialWidth); initialHeight = Math.round(initialHeight); widthSlider.min = initialWidth; widthSlider.max = 500; widthSlider.value = initialWidth; heightSlider.min = initialHeight; heightSlider.max = 500; heightSlider.value = initialHeight; previewBox.style.width = `${initialWidth}px`; previewBox.style.height = `${initialHeight}px`; }
        
        function updateLineButtons() { const config = configurations[activeEditor]; if (!config.image) return; document.querySelector('.line-control-btn[data-line="top"]').classList.toggle('active', config.regions.stretch.top !== null); document.querySelector('.line-control-btn[data-line="left"]').classList.toggle('active', config.regions.stretch.left !== null); }
        
        let populatedSpans = {}; function updateInfoPanel() { if (!populatedSpans.imgSize) { populatedSpans = { imgSize: document.getElementById('img-size'), stretch: { horiz: document.getElementById('stretch-horiz'), vert: document.getElementById('stretch-vert') }, content: { top: document.getElementById('content-top'), bottom: document.getElementById('content-bottom'), left: document.getElementById('content-left'), right: document.getElementById('content-right') } }; } const config = configurations[activeEditor]; if (!config.image) return; populatedSpans.imgSize.textContent = `${config.image.width} x ${config.image.height} px`; const s = config.regions.stretch; populatedSpans.stretch.horiz.textContent = (s.left !== null) ? `${Math.round(s.left)} - ${Math.round(s.right)}` : '固定'; populatedSpans.stretch.vert.textContent = (s.top !== null) ? `${Math.round(s.top)} - ${Math.round(s.bottom)}` : '固定'; const c = config.regions.content; ['top', 'bottom', 'left', 'right'].forEach(line => { populatedSpans.content[line].textContent = c[line] !== null ? Math.round(c[line]) : 'N/A'; }); }
        
        function updatePreview() { const config = configurations[activeEditor]; if (!config.image) return; const { width: w, height: h } = config.image; const sr = config.regions.stretch; const cr = config.regions.content; const slice = { top: (sr.top !== null) ? Math.round(sr.top) : 0, right: (sr.left !== null) ? Math.round(w - sr.right) : 0, bottom: (sr.top !== null) ? Math.round(h - sr.bottom) : 0, left: (sr.left !== null) ? Math.round(sr.left) : 0 }; const scaleFactor = Math.max(1, Math.round(Math.min(w, h) / 100)); const borderWidth = { top: Math.round(slice.top / scaleFactor), right: Math.round(slice.right / scaleFactor), bottom: Math.round(slice.bottom / scaleFactor), left: Math.round(slice.left / scaleFactor) }; const padding = { top: cr.top !== null ? Math.round(cr.top / scaleFactor) : 0, right: cr.right !== null ? Math.round((w - cr.right) / scaleFactor) : 0, bottom: cr.bottom !== null ? Math.round((h - cr.bottom) / scaleFactor) : 0, left: cr.left !== null ? Math.round(cr.left / scaleFactor) : 0 }; previewBox.style.borderImageSource = `url('${config.image.src}')`; previewBox.style.borderImageSlice = `${slice.top} ${slice.right} ${slice.bottom} ${slice.left} fill`; previewBox.style.borderImageWidth = `${borderWidth.top}px ${borderWidth.right}px ${borderWidth.bottom}px ${borderWidth.left}px`; previewContentArea.style.top = `${padding.top}px`; previewContentArea.style.right = `${padding.right}px`; previewContentArea.style.bottom = `${padding.bottom}px`; previewContentArea.style.left = `${padding.left}px`; widthSlider.disabled = (sr.left === null); heightSlider.disabled = (sr.top === null); }
        
        function setupCanvas() { const img = configurations[activeEditor].image; if (!img) return; canvas.width = img.width + 2; canvas.height = img.height + 2; }
        
        function resetRegions(editor, mode = 'all') { const img = configurations[editor].image; if (!img) return; const w = img.width; const h = img.height; if (mode === 'all' || mode === 'stretch') { configurations[editor].regions.stretch = { top: h * 0.25, bottom: h * 0.75, left: w * 0.25, right: w * 0.75 }; } if (mode === 'all' || mode === 'content') { configurations[editor].regions.content = { top: h * 0.25, bottom: h * 0.75, left: w * 0.25, right: w * 0.75 }; } }
        function drawCanvasContents() {
            const config = configurations[activeEditor];
            if (!config.image) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(config.image, 1, 1);
            drawNinePatchBorders();
            drawGuideLines();
            updateLineButtons();
        }
        function redrawAll() {
            const config = configurations[activeEditor];
            if (!config.image) return;
            const mainContent = document.querySelector('.main-content');
            const ratioX = mainContent.clientWidth / canvas.width;
            const ratioY = mainContent.clientHeight / canvas.height;
            scale = Math.min(ratioX, ratioY) * 0.9;
            
            canvas.style.width = `${canvas.width * scale}px`;
            canvas.style.height = `${canvas.height * scale}px`;
            canvas.style.transform = '';

            drawCanvasContents(); // 调用新的绘图函数
        }
        
        function drawNinePatchBorders() { const config = configurations[activeEditor]; if (!config.image) return; const s = config.regions.stretch; const c = config.regions.content; ctx.fillStyle = '#000000'; if (s.left !== null) ctx.fillRect(Math.round(s.left) + 1, 0, Math.max(1, Math.round(s.right - s.left)), 1); if (s.top !== null) ctx.fillRect(0, Math.round(s.top) + 1, 1, Math.max(1, Math.round(s.bottom - s.top))); if (c.left !== null) ctx.fillRect(Math.round(c.left) + 1, canvas.height - 1, Math.max(1, Math.round(c.right - c.left)), 1); if (c.top !== null) ctx.fillRect(canvas.width - 1, Math.round(c.top) + 1, 1, Math.max(1, Math.round(c.bottom - c.top))); }
        
        function drawGuideLines() { const config = configurations[activeEditor]; if (!config.image) return; const r = config.regions[currentMode]; const color = getComputedStyle(document.documentElement).getPropertyValue(`--${currentMode}-color`); ctx.strokeStyle = color; ctx.lineWidth = 1 / scale; ctx.setLineDash([4 / scale, 3 / scale]); if (r.left !== null) { ctx.beginPath(); ctx.moveTo(r.left + 1, 1); ctx.lineTo(r.left + 1, config.image.height + 1); ctx.stroke(); } if (r.right !== null) { ctx.beginPath(); ctx.moveTo(r.right + 1, 1); ctx.lineTo(r.right + 1, config.image.height + 1); ctx.stroke(); } if (r.top !== null) { ctx.beginPath(); ctx.moveTo(1, r.top + 1); ctx.lineTo(config.image.width + 1, r.top + 1); ctx.stroke(); } if (r.bottom !== null) { ctx.beginPath(); ctx.moveTo(1, r.bottom + 1); ctx.lineTo(config.image.width + 1, r.bottom + 1); ctx.stroke(); } ctx.setLineDash([]); }
        
        function getEventPos(e) { const rect = canvas.getBoundingClientRect(); const clientX = e.touches ? e.touches[0].clientX : e.clientX; const clientY = e.touches ? e.touches[0].clientY : e.clientY; return { x: (clientX - rect.left) / scale - 1, y: (clientY - rect.top) / scale - 1, }; }
        
        function onDown(e) { const config = configurations[activeEditor]; if (!config.image) return; e.preventDefault(); const pos = getEventPos(e); const r = config.regions[currentMode]; const threshold = TOUCH_THRESHOLD / scale; const dists = {}; if(r.top !== null) dists.top = Math.abs(pos.y - r.top); if(r.bottom !== null) dists.bottom = Math.abs(pos.y - r.bottom); if(r.left !== null) dists.left = Math.abs(pos.x - r.left); if(r.right !== null) dists.right = Math.abs(pos.x - r.right); let min_dist = Infinity; let closest_line = null; for (const [line, dist] of Object.entries(dists)) { if (dist < min_dist) { min_dist = dist; closest_line = line; } } if (min_dist < threshold) { isDragging = true; draggingLine = closest_line; } }
        
        function onUp() { isDragging = false; draggingLine = null; }
        
        function openDownloadModal() {
            const hasAi = !!configurations.ai.image; const hasUser = !!configurations.user.image;
            document.getElementById('ai-url-group').style.display = hasAi ? 'block' : 'none';
            document.getElementById('user-url-group').style.display = hasUser ? 'block' : 'none';
            const anyImage = hasAi || hasUser;
            document.querySelectorAll('.css-preview-trigger').forEach(btn => btn.disabled = !anyImage);
            document.getElementById('download-code-btn').disabled = !anyImage;
            document.getElementById('download-image-btn').disabled = !configurations[activeEditor].image;
            document.getElementById('download-options-view').style.display = 'flex';
            document.getElementById('code-preview-view').style.display = 'none';
            modal.style.display = 'flex';
        }
        
        function downloadImage(editor) { const config = configurations[editor]; if (!config.image) { alert(`请先为 ${editor.toUpperCase()} 标签页上传图片！`); return; } const tempCanvas = document.createElement('canvas'); tempCanvas.width = config.image.width + 2; tempCanvas.height = config.image.height + 2; const tempCtx = tempCanvas.getContext('2d'); tempCtx.drawImage(config.image, 1, 1); const s = config.regions.stretch; const c = config.regions.content; tempCtx.fillStyle = '#000000'; if (s.left !== null) tempCtx.fillRect(Math.round(s.left) + 1, 0, Math.max(1, Math.round(s.right - s.left)), 1); if (s.top !== null) tempCtx.fillRect(0, Math.round(s.top) + 1, 1, Math.max(1, Math.round(s.bottom - s.top))); if (c.left !== null) tempCtx.fillRect(Math.round(c.left) + 1, tempCanvas.height - 1, Math.max(1, Math.round(c.right - c.left)), 1); if (c.top !== null) tempCtx.fillRect(tempCanvas.width - 1, Math.round(c.top) + 1, 1, Math.max(1, Math.round(c.bottom - c.top))); const dataUrl = tempCanvas.toDataURL('image/png'); const link = document.createElement('a'); const nameParts = config.fileName.split('.'); nameParts.pop(); const baseName = nameParts.join('.').replace(/\.9$/, ''); link.download = `${baseName}.9.png`; link.href = dataUrl; link.click(); }
        
        // =========================================================================
        // ======================= START: CORRECTED CODE BLOCK =======================
        // =========================================================================

        function generateBubbleCss(config) {
            const scaleFactor = parseFloat(document.getElementById('scale-factor-input').value) || 18;
            const { image, regions } = config;
            const { width: w, height: h } = image;
            const sr = regions.stretch; 
            const cr = regions.content;

            // --- 核心逻辑判断 ---
            const isHorizontalOnlyStretch = sr.left !== null && sr.top === null;
            const isVerticalOnlyStretch = sr.left === null && sr.top !== null;
            const isFixed = sr.left === null && sr.top === null;

            let extraStyles = '', comment = '';

            if (isHorizontalOnlyStretch) {
                comment = `/* H-Stretch Only, Fixed Height */`;
                extraStyles = `height: ${Math.round(h / scaleFactor)}px; width: fit-content; white-space: nowrap; display: flex; align-items: center;`;
            } else if (isVerticalOnlyStretch) {
                comment = `/* V-Stretch Only, Fixed Width */`;
                extraStyles = `width: ${Math.round(w / scaleFactor)}px;`;
            } else if (isFixed) {
                comment = `/* Fixed Size */`;
                extraStyles = `width: ${Math.round(w / scaleFactor)}px; height: ${Math.round(h / scaleFactor)}px;`;
            } else { // Full stretch
                comment = `/* Full Stretch */`;
                extraStyles = 'width: fit-content; max-width: 230px; word-wrap: break-word;';
            }
            
            const slice = { 
                top: sr.top !== null ? Math.round(sr.top) : 0, 
                right: sr.left !== null ? Math.round(w - sr.right) : 0, 
                bottom: sr.top !== null ? Math.round(h - sr.bottom) : 0, 
                left: sr.left !== null ? Math.round(sr.left) : 0 
            };
            const borderWidth = { 
                top: `${Math.round(slice.top / scaleFactor)}px`, 
                right: `${Math.round(slice.right / scaleFactor)}px`, 
                bottom: `${Math.round(slice.bottom / scaleFactor)}px`, 
                left: `${Math.round(slice.left / scaleFactor)}px` 
            };
            const padding = { 
                top: `${Math.round(cr.top / scaleFactor)}px`, 
                right: `${Math.round((w - cr.right) / scaleFactor)}px`, 
                bottom: `${Math.round((h - cr.bottom) / scaleFactor)}px`, 
                left: `${Math.round(cr.left / scaleFactor)}px` 
            };

            // 返回一个包含所有信息的对象
            return { slice, borderWidth, padding, extraStyles, comment };
        }

        function generateHtmlCode() {
            const hasAi = !!configurations.ai.image; const hasUser = !!configurations.user.image;
            if (!hasAi && !hasUser) { alert('请至少上传一张图片！'); return null; }
            const leftText = document.getElementById('left-text-input').value; const rightText = document.getElementById('right-text-input').value;
            let combinedStyle = '', transformStyle = '', leftBubbleClass = 'bubble left', rightBubbleClass = 'bubble right';
            const aiUrl = document.getElementById('ai-url-input').value; const userUrl = document.getElementById('user-url-input').value;

            const commonBase = `line-height: 1.6; font-size: 16px; border-style: solid; box-sizing: border-box;`;

            if (hasAi && hasUser) {
                if (!aiUrl || !userUrl) { alert('请输入AI和User两张图片的URL！'); return null; }
                const aiData = generateBubbleCss(configurations.ai); 
                const userData = generateBubbleCss(configurations.user);
                
                const aiBubble = `border-image-source: url('${aiUrl}'); border-image-slice: ${aiData.slice.top} ${aiData.slice.right} ${aiData.slice.bottom} ${aiData.slice.left} fill; border-image-width: ${aiData.borderWidth.top} ${aiData.borderWidth.right} ${aiData.borderWidth.bottom} ${aiData.borderWidth.left}; padding: ${aiData.padding.top} ${aiData.padding.right} ${aiData.padding.bottom} ${aiData.padding.left};`;
                const userBubble = `border-image-source: url('${userUrl}'); border-image-slice: ${userData.slice.top} ${userData.slice.right} ${userData.slice.bottom} ${userData.slice.left} fill; border-image-width: ${userData.borderWidth.top} ${userData.borderWidth.right} ${userData.borderWidth.bottom} ${userData.borderWidth.left}; padding: ${userData.padding.top} ${userData.padding.right} ${userData.padding.bottom} ${userData.padding.left};`;
                
                combinedStyle = `${aiData.comment}\n.bubble.left { align-self: flex-start; ${commonBase} ${aiData.extraStyles} ${aiBubble} }\n${userData.comment}\n.bubble.right { align-self: flex-end; ${commonBase} ${userData.extraStyles} ${userBubble} }`;
                transformStyle = `.bubble .content-wrapper { text-align: left; }`; // ✨ 修正：简化为通用规则
            } else {
                const singleConfig = hasAi ? configurations.ai : configurations.user;
                const singleUrl = hasAi ? aiUrl : userUrl;
                if (!singleUrl) { alert('请输入已上传图片的URL！'); return null; }
                const data = generateBubbleCss(singleConfig); 
                const selectedSide = document.querySelector('input[name="side"]:checked').value;
                const base = `${commonBase} ${data.extraStyles} border-image-source: url('${singleUrl}'); border-image-slice: ${data.slice.top} ${data.slice.right} ${data.slice.bottom} ${data.slice.left} fill; border-image-width: ${data.borderWidth.top} ${data.borderWidth.right} ${data.borderWidth.bottom} ${data.borderWidth.left};`;
                const normalPadding = `padding: ${data.padding.top} ${data.padding.right} ${data.padding.bottom} ${data.padding.left};`;
                
                if (selectedSide === 'left') {
                    combinedStyle = `${data.comment}\n.bubble.left { align-self: flex-start; ${base} ${normalPadding} }\n.bubble.right { align-self: flex-end; ${base} ${normalPadding} transform: scaleX(-1); }`;
                    // ✨ 核心修正：使用 * 选择器反转所有内部元素
                    transformStyle = `.bubble .content-wrapper { text-align: left; } .bubble.right * { transform: scaleX(-1); }`;
                } else if (selectedSide === 'right') {
                    combinedStyle = `${data.comment}\n.bubble.right { align-self: flex-end; ${base} ${normalPadding} }\n.bubble.left { align-self: flex-start; ${base} ${normalPadding} transform: scaleX(-1); }`;
                    // ✨ 核心修正：使用 * 选择器反转所有内部元素
                    transformStyle = `.bubble .content-wrapper { text-align: left; } .bubble.left * { transform: scaleX(-1); }`;
                } else {
                    // 中间位置 (Center)：统一居中显示，不再区分左右对齐
                    combinedStyle = `${data.comment}\n.bubble.left, .bubble.right { align-self: center; ${base} ${normalPadding} }`;
                    transformStyle = `.bubble .content-wrapper { text-align: center; }`;
                }
            }
            return `<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>代码演示</title><style>body { background-color: #f0f0f0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; padding: 40px; display: flex; justify-content: center; align-items: center; } .chat-container { max-width: 700px; width: 100%; display: flex; flex-direction: column; gap: 30px; } .bubble { align-self: flex-start; } ${combinedStyle} ${transformStyle}</style></head><body><div class="chat-container"><div class="${leftBubbleClass}"><div class="content-wrapper">${leftText.replace(/\n/g, '<br>')}</div></div><div class="${rightBubbleClass}"><div class="content-wrapper">${rightText.replace(/\n/g, '<br>')}</div></div></div></body></html>`;
        };
        
        function downloadCode() { const code = generateHtmlCode(); if(!code) return; downloadFile(code, 'demo.html', 'text/html'); modal.style.display = 'none'; };
        
        async function showCodePreview(target) {
            const bubbleName = document.getElementById('ai-url-input').value || document.getElementById('user-url-input').value ? (configurations.ai.fileName || configurations.user.fileName).split('.')[0] : "我的气泡";
            let code = '', fileName = '', title = '';

            const isAppFormat = ['receiver', 'sender', 'global'].includes(target);
            
            if (isAppFormat) {
                const result = generateAppCss(target, bubbleName);
                if (!result) return;
                code = result.css;
                fileName = result.fileName;
                title = result.title;
            } else {
                const result = generateEphoneCss(target, bubbleName);
                if (!result) return;
                code = result.css;
                fileName = result.fileName;
                title = result.title;
            }
            
            document.getElementById('code-preview-title').textContent = title;
            const textarea = document.getElementById('code-preview-textarea');
            textarea.value = code;
            
            document.getElementById('download-options-view').style.display = 'none';
            document.getElementById('code-preview-view').style.display = 'flex';

            const copyBtn = document.getElementById('copy-code-btn');
            const downloadBtn = document.getElementById('download-file-btn');

            copyBtn.onclick = () => {
                navigator.clipboard.writeText(textarea.value).then(() => {
                    copyBtn.textContent = '已复制!';
                    setTimeout(() => { copyBtn.textContent = '复制'; }, 2000);
                });
            };
            downloadBtn.onclick = () => {
                downloadFile(textarea.value, fileName, 'text/css');
                modal.style.display = 'none';
            };
        }

        function generateAppCss(target, bubbleName) {
            const hasAi = !!configurations.ai.image;
            const hasUser = !!configurations.user.image;
            if (!hasAi && !hasUser) { alert("请至少上传一张图片！"); return null; }
            
            const bubbleMode = document.querySelector('input[name="bubble-mode"]:checked').value;
            const aiUrl = document.getElementById('ai-url-input').value;
            const userUrl = document.getElementById('user-url-input').value;

            let receiverCssParts, senderCssParts;

            if (hasAi && hasUser) {
                if (!aiUrl || !userUrl) { alert("请输入AI和User两张图片的URL！"); return null; }
                const aiData = generateBubbleCss(configurations.ai);
                const userData = generateBubbleCss(configurations.user);
                receiverCssParts = createAppCssString('receiver', aiData, aiUrl, bubbleMode, false);
                senderCssParts = createAppCssString('sender', userData, userUrl, bubbleMode, false);
            } else {
                const singleConfig = hasAi ? configurations.ai : configurations.user;
                const singleUrl = hasAi ? aiUrl : userUrl;
                if (!singleUrl) { alert("请输入已上传图片的URL！"); return null; }
                const data = generateBubbleCss(singleConfig);
                const selectedSide = document.querySelector('input[name="side"]:checked').value;

                if (selectedSide === 'left') {
                    receiverCssParts = createAppCssString('receiver', data, singleUrl, bubbleMode, false);
                    senderCssParts = createAppCssString('sender', data, singleUrl, bubbleMode, true);
                } else if (selectedSide === 'right') {
                    receiverCssParts = createAppCssString('receiver', data, singleUrl, bubbleMode, true);
                    senderCssParts = createAppCssString('sender', data, singleUrl, bubbleMode, false);
                } else { // center
                    receiverCssParts = createAppCssString('receiver', data, singleUrl, bubbleMode, false);
                    senderCssParts = createAppCssString('sender', data, singleUrl, bubbleMode, false);
                }
            }

            let finalCss = '', fileName = bubbleName.trim(), title = '';
            
            // ================== 核心修正：全新的、清晰的下载逻辑 ==================
            if (target === 'receiver' || target === 'sender') {
                const parts = (target === 'receiver') ? receiverCssParts : senderCssParts;
                const sideName = (target === 'receiver') ? '接收方' : '发送方';

                // ================== 核心升级：在这里！ ==================
                if (bubbleMode === 'all') {
                    // 如果是“全部使用气泡”模式，我们就生成全新的、万能的自定义气泡代码！
                    const flip = (target === 'sender') ? parts.flipSender : parts.flipReceiver;

                    finalCss = `/* --- ${bubbleName} - ${sideName} (万能悬浮版) --- */

/* 1. 画框 (@parent) */
@parent {
    border-style: solid !important;
    border-image-source: url('${parts.url}') !important;
    border-image-slice: ${parts.slice} !important;
    border-image-width: ${parts.borderWidth} !important;
    padding: 0 !important;
    background: transparent !important;
    border-radius: 0 !important;
    max-width: 230px !important;
    box-sizing: border-box !important;
    ${flip ? 'transform: scaleX(-1);' : ''}
}

/* 2. 悬浮卡片 (&) */
&.transfer, &.red_packet, &.location, &.gift, &.pay_for_me, &.photo, &.video, &.photo-description {
    margin: ${flip ? parts.flippedMargin : parts.margin} !important;
    position: relative;
    z-index: 1;
    border-radius: 12px !important;
    overflow: hidden;
}

/* 3. 文本/语音 (&.text, &.voice) */
&.text,
&.voice {
    z-index: auto;
    margin: 0 !important;
    padding: ${flip ? parts.flippedPadding : parts.padding} !important;
    color: black !important;
    background: transparent !important;
    border: none !important;
    box-shadow: none !important;
}

/* 4. 内容反向翻转 (&) */
${flip ? `& { transform: scaleX(-1); }` : ''}


/* 5. 清理 */
@parent::after, &::before, &::after {
    display: none !important;
}`;
                    fileName += `-${sideName}-万能自定义气泡.css`;
                    title = `${sideName} (万能自定义气泡)`;

                } else {
                    // 否则，保持原样，生成旧的、仅用于文本的自定义气泡代码
                    finalCss = parts.custom;
                    fileName += `-${sideName}-自定义气泡.css`;
                    title = `${sideName} (自定义气泡格式)`;
                }
                // =======================================================

            } else if (target === 'global') {

                const buildGlobalCss = (parts) => {
                    if (bubbleMode === 'all') {
                        return `/* --- 画框: ${parts.isReceiver ? '接收方' : '发送方'} --- */\n${parts.globalFrame}\n\n` +
                               `/* --- 悬浮卡片 Margin: ${parts.isReceiver ? '接收方' : '发送方'} --- */\n${parts.globalSuspendedMargin}\n\n` +
                               `/* --- 文本/语音: ${parts.isReceiver ? '接收方' : '发送方'} --- */\n${parts.globalTextVoice}\n`;
                    } else { // text-only
                        return `/* --- 文本/语音: ${parts.isReceiver ? '接收方' : '发送方'} --- */\n${parts.global}\n`;
                    }
                };

                const receiverGlobal = buildGlobalCss(receiverCssParts);
                const senderGlobal = buildGlobalCss(senderCssParts);
                
                
                if (bubbleMode === 'all') {
                    finalCss = `/* --- ${bubbleName} - 全局美化 (全部气泡模式) --- */\n\n` +
                             `/* 1. 悬浮卡片通用样式 (只需一份) */\n${receiverCssParts.globalSuspended}\n\n` +
                             `/* 2. (条件性) 内容翻转 (只需一份) */\n${senderCssParts.globalFlipContent || receiverCssParts.globalFlipContent}\n\n` +
                             receiverGlobal + senderGlobal +
                             `/* 99. 清理 (只需一份) */\n${receiverCssParts.globalCleanup}\n`;
                } else {
                    finalCss = `/* --- ${bubbleName} - 全局美化 (仅文本语音模式) --- */\n\n` +
                             `/* 1. 基础重置 (只需一份) */\n${receiverCssParts.globalReset}\n\n` +
                             receiverGlobal + senderGlobal +
                             `/* 99. 共享样式 (只需一份) */\n${receiverCssParts.globalSharedChildren}\n`;
                }
                
                fileName += '-全局美化.css';
                title = '全局美化格式';

            } else { // Ephone format
                const result = generateEphoneCss(target, bubbleName);
                if (!result) return null;
                finalCss = result.css;
                fileName = result.fileName;
                title = result.title;
            }
            
            return { css: finalCss, fileName, title };
        }
        function createAppCssString(side, data, url, bubbleMode, flip = false) {
            const isReceiver = side === 'receiver';
            const flipTransform = flip ? ' transform: scaleX(-1);' : '';
            const customPadding = `${data.padding.top} ${data.padding.right} ${data.padding.bottom} ${data.padding.left}`;

            const preciseFlipBack = flip ? `
& .single-line-text,
& .reply-text,
& .voice-details,
& .quoted-message-preview {
    transform: scaleX(-1);
}` : '';

            // ================== 核心修正：为“仅文本语音”模式重写 customCss ==================
            const customCss = `/* 
 * 步骤一：【精确打击】只为文本和语音消息应用皮肤
 */
&.text,
&.voice {
    /* --- 关键：重置默认样式 --- */
    border-radius: 0 !important;
    box-shadow: none !important;
    background: transparent !important;
    border: none !important;
    border-style: solid !important;
    box-sizing: border-box !important;
    color: #000 !important;
    min-width: 0 !important;
    line-height: 1.6 !important;
    font-size: 16px !important;
    ${data.extraStyles}

    /* --- 图片边框样式 --- */
    border-image-source: url('${url}') !important;
    border-image-slice: ${data.slice.top} ${data.slice.right} ${data.slice.bottom} ${data.slice.left} fill !important;
    border-image-width: ${data.borderWidth.top} ${data.borderWidth.right} ${data.borderWidth.bottom} ${data.borderWidth.left} !important;
    padding: ${customPadding} !important;${flipTransform}
}

/*
 * 步骤二：清理默认的三角箭头
 */
&.text::before, &.text::after,
&.voice::before, &.voice::after {
    display: none !important;
}

/*
 * 步骤三：确保内部元素颜色正确，并实现精准反向翻转
 */
&.text * , &.voice * { 
    color: inherit !important; 
}
${preciseFlipBack}
& .quoted-message-preview { 
    background-color: transparent !important; 
    border-color: rgba(0,0,0,0.2) !important; 
}`;
            // =================================================================================

            const globalReset = `#page-conversation .message.text, #page-conversation .message.voice { border-radius: 0 !important; box-shadow: none !important; background: transparent !important; border: none !important; border-style: solid !important; box-sizing: border-box !important; color: #000 !important; min-width: 0 !important; line-height: 1.6 !important; font-size: 16px !important; width: auto; height: auto; }`;
            const globalSelector = isReceiver ? `#page-conversation .message.received.text,\n#page-conversation .message.received.voice` : `#page-conversation .message.sent.text,\n#page-conversation .message.sent.voice`;
            const preciseGlobalFlipBack = flip ? `
${isReceiver ? '#page-conversation .message.received' : '#page-conversation .message.sent'} .single-line-text,
${isReceiver ? '#page-conversation .message.received' : '#page-conversation .message.sent'} .reply-text,
${isReceiver ? '#page-conversation .message.received' : '#page-conversation .message.sent'} .voice-details,
${isReceiver ? '#page-conversation .message.received' : '#page-conversation .message.sent'} .quoted-message-preview {
    transform: scaleX(-1);
}` : '';
            const globalCss = `${globalSelector} {\n    ${data.extraStyles}\n    border-image-source: url('${url}') !important;\n    border-image-slice: ${data.slice.top} ${data.slice.right} ${data.slice.bottom} ${data.slice.left} fill !important;\n    border-image-width: ${data.borderWidth.top} ${data.borderWidth.right} ${data.borderWidth.bottom} ${data.borderWidth.left} !important;\n    padding: ${customPadding} !important;${flipTransform}\n}\n${preciseGlobalFlipBack}`;
            const globalSharedChildren = `\n#page-conversation .message.text * , #page-conversation .message.voice * { color: inherit !important; }\n#page-conversation .quoted-message-preview { background-color: transparent !important; border-color: rgba(0,0,0,0.2) !important; }\n#page-conversation .message.text::before, #page-conversation .message.text::after, #page-conversation .message.voice::before, #page-conversation .message.voice::after { display: none !important; }`;
            const frameSelector = isReceiver ? `#page-conversation .message-wrapper.received .message-main-content` : `#page-conversation .message-wrapper.sent .message-main-content`;
            const globalFrame = `${frameSelector} {
    border-style: solid !important;
    border-image-source: url('${url}') !important;
    border-image-slice: ${data.slice.top} ${data.slice.right} ${data.slice.bottom} ${data.slice.left} fill !important;
    border-image-width: ${data.borderWidth.top} ${data.borderWidth.right} ${data.borderWidth.bottom} ${data.borderWidth.left} !important;
    padding: 0 !important;
    background: transparent !important;
    border-radius: 0 !important;
    max-width: 230px !important;
    box-sizing: border-box !important;${flipTransform}
}`;
            const globalSuspended = (isReceiver) ? `/* For all suspended cards */
#page-conversation .message.transfer, #page-conversation .message.red_packet, #page-conversation .message.location, #page-conversation .message.gift, #page-conversation .message.pay_for_me, #page-conversation .message.photo, #page-conversation .message.video, #page-conversation .message.photo-description {
    position: relative; z-index: 1; border-radius: 12px !important; overflow: hidden;
}` : '';
            const suspendedSelector = isReceiver 
                ? `#page-conversation .message-wrapper.received .message.transfer,\n#page-conversation .message-wrapper.received .message.red_packet,\n#page-conversation .message-wrapper.received .message.location,\n#page-conversation .message-wrapper.received .message.gift,\n#page-conversation .message-wrapper.received .message.pay_for_me,\n#page-conversation .message-wrapper.received .message.photo,\n#page-conversation .message-wrapper.received .message.video,\n#page-conversation .message-wrapper.received .message.photo-description`
                : `#page-conversation .message-wrapper.sent .message.transfer,\n#page-conversation .message-wrapper.sent .message.red_packet,\n#page-conversation .message-wrapper.sent .message.location,\n#page-conversation .message-wrapper.sent .message.gift,\n#page-conversation .message-wrapper.sent .message.pay_for_me,\n#page-conversation .message-wrapper.sent .message.photo,\n#page-conversation .message-wrapper.sent .message.video,\n#page-conversation .message-wrapper.sent .message.photo-description`;
            const suspendedMargin = `margin: ${data.padding.top} ${data.padding.right} ${data.padding.bottom} ${data.padding.left} !important;`;
            const globalSuspendedMargin = `${suspendedSelector} {\n    ${suspendedMargin}\n}`;
            const flipTargetSelector = isReceiver ? '#page-conversation .message-wrapper.received .message' : '#page-conversation .message-wrapper.sent .message';
            const globalFlipContent = flip ? `\n/* Flip content back for the flipped side */\n${flipTargetSelector} {\n    transform: scaleX(-1);\n}` : '';
            const textVoiceSelector = isReceiver ? `#page-conversation .message.received.text,\n#page-conversation .message.received.voice` : `#page-conversation .message.sent.text,\n#page-conversation .message.sent.voice`;
            const textVoicePadding = `padding: ${data.padding.top} ${data.padding.right} ${data.padding.bottom} ${data.padding.left} !important;`;
            const globalTextVoice = `${textVoiceSelector} {\n    background: transparent !important;\n    border: none !important;\n    box-shadow: none !important;\n    margin: 0 !important;\n    color: black !important;\n    position: relative; /* Ensure it's rendered correctly */\n    ${textVoicePadding}\n}`;
            const globalCleanup = (isReceiver) ? `/* Cleanup default pointers */\n#page-conversation .message-main-content::after,\n#page-conversation .message::before,\n#page-conversation .message::after,\n#page-conversation .message.sent.text::before,\n#page-conversation .message.received.text::after {\n    display: none !important;\n}` : '';

            return { 
                custom: customCss, 
                global: globalCss, 
                globalReset: globalReset, 
                globalSharedChildren: globalSharedChildren,
                globalFrame: globalFrame,
                globalSuspended: globalSuspended,
                globalTextVoice: globalTextVoice,
                globalCleanup: globalCleanup,
                globalFlipContent: globalFlipContent,
                globalSuspendedMargin: globalSuspendedMargin,
                // ================== 新增的返回零件 ==================
                isReceiver: isReceiver,
                url: url,
                slice: `${data.slice.top} ${data.slice.right} ${data.slice.bottom} ${data.slice.left} fill`,
                borderWidth: `${data.borderWidth.top} ${data.borderWidth.right} ${data.borderWidth.bottom} ${data.borderWidth.left}`,
                margin: `${data.padding.top} ${data.padding.right} ${data.padding.bottom} ${data.padding.left}`,
                flippedMargin: `${data.padding.top} ${data.padding.left} ${data.padding.bottom} ${data.padding.right}`,
                padding: `${data.padding.top} ${data.padding.right} ${data.padding.bottom} ${data.padding.left}`,
                flippedPadding: `${data.padding.top} ${data.padding.left} ${data.padding.bottom} ${data.padding.right}`,
                flipSender: (side === 'sender' && flip),
                flipReceiver: (side === 'receiver' && flip)
                // =================================================
            };
        }

        function generateEphoneCss(target, bubbleName) {
            const processConfig = (config, color) => {
                const data = generateBubbleCss(config); 
                return { ...data, color };
            };
            
            const aiColor = document.getElementById('ai-color-input').value; const userColor = document.getElementById('user-color-input').value;
            const header = `/*\n * =======================================================\n *   气泡样式: ${bubbleName}\n *   - 异形气泡制作工具作者：酱酱\n *   - 声明：仅允许免费小手机使用，禁止抄袭思路\n * =======================================================\n*/\n\n`;
            const baseRules = `.message-bubble.user .content,\n.message-bubble.ai .content { background: transparent !important; border: none !important; border-radius: 0 !important; box-shadow: none !important; backdrop-filter: none !important; -webkit-backdrop-filter: none !important; position: relative; z-index: 1; }\n.message-bubble.user .content::before,\n.message-bubble.ai .content::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: -1; border-style: solid; border-image-repeat: repeat; }\n`;
            let aiCss = '', userCss = '';
            
            const hasAi = !!configurations.ai.image; const hasUser = !!configurations.user.image;
            if (!hasAi && !hasUser) { alert("请至少上传一张图片！"); return null; }

            const aiUrl = document.getElementById('ai-url-input').value; const userUrl = document.getElementById('user-url-input').value;

            if (hasAi && hasUser) {
                if(target === 'ai' || target === 'full') {
                    if(!aiUrl){ alert('请输入AI图片的URL！'); return null; }
                    const data = processConfig(configurations.ai, aiColor);
                    aiCss = `\n/* --- AI气泡 (左侧/接收方) --- */\n.message-bubble.ai .content::before { border-image-source: url('${aiUrl}'); border-image-slice: ${data.slice.top} ${data.slice.right} ${data.slice.bottom} ${data.slice.left} fill; border-image-width: ${data.borderWidth.top} ${data.borderWidth.right} ${data.borderWidth.bottom} ${data.borderWidth.left}; }\n.message-bubble.ai .content { padding: ${data.padding.top} ${data.padding.right} ${data.padding.bottom} ${data.padding.left}; color: ${data.color}; ${data.extraStyles} }\n`;
                }
                if(target === 'user' || target === 'full') {
                    if(!userUrl){ alert('请输入User图片的URL！'); return null; }
                    const data = processConfig(configurations.user, userColor);
                    userCss = `\n/* --- 用户气泡 (右侧/发送方) --- */\n.message-bubble.user .content::before { border-image-source: url('${userUrl}'); border-image-slice: ${data.slice.top} ${data.slice.right} ${data.slice.bottom} ${data.slice.left} fill; border-image-width: ${data.borderWidth.top} ${data.borderWidth.right} ${data.borderWidth.bottom} ${data.borderWidth.left}; }\n.message-bubble.user .content { padding: ${data.padding.top} ${data.padding.right} ${data.padding.bottom} ${data.padding.left}; color: ${data.color}; ${data.extraStyles} }\n`;
                }
            } else if (hasAi || hasUser) {
                const singleConfig = hasAi ? configurations.ai : configurations.user;
                const singleUrl = hasAi ? aiUrl : userUrl;
                if (!singleUrl) { alert('请输入已上传图片的URL！'); return null; }
                const selectedSide = document.querySelector('input[name="side"]:checked').value;
                const data = processConfig(singleConfig, '#_placeholder_#');
                const beforeStyle = `border-image-source: url('${singleUrl}'); border-image-slice: ${data.slice.top} ${data.slice.right} ${data.slice.bottom} ${data.slice.left} fill; border-image-width: ${data.borderWidth.top} ${data.borderWidth.right} ${data.borderWidth.bottom} ${data.borderWidth.left};`;
                
                const aiPaddingStyle = `padding: ${data.padding.top} ${data.padding.right} ${data.padding.bottom} ${data.padding.left}; color: ${aiColor}; ${data.extraStyles}`;
                const userPaddingStyle = `padding: ${data.padding.top} ${data.padding.right} ${data.padding.bottom} ${data.padding.left}; color: ${userColor}; ${data.extraStyles}`;
                
                const flippedPadding = `padding: ${data.padding.top} ${data.padding.left} ${data.padding.bottom} ${data.padding.right};`;
                const aiFlippedPaddingStyle = `${flippedPadding} color: ${aiColor}; ${data.extraStyles}`;
                const userFlippedPaddingStyle = `${flippedPadding} color: ${userColor}; ${data.extraStyles}`;

                switch (selectedSide) {
                    case 'left':
                        aiCss = `\n/* --- AI气泡 (左侧/接收方) --- */\n.message-bubble.ai .content::before { ${beforeStyle} }\n.message-bubble.ai .content { ${aiPaddingStyle} }\n`;
                        userCss = `\n/* --- 用户气泡 (右侧/发送方 - 翻转) --- */\n.message-bubble.user .content::before { ${beforeStyle} transform: scaleX(-1); }\n.message-bubble.user .content { ${userFlippedPaddingStyle} }\n`;
                        break;
                    case 'right':
                        aiCss = `\n/* --- AI气泡 (左侧/接收方 - 翻转) --- */\n.message-bubble.ai .content::before { ${beforeStyle} transform: scaleX(-1); }\n.message-bubble.ai .content { ${aiFlippedPaddingStyle} }\n`;
                        userCss = `\n/* --- 用户气泡 (右侧/发送方) --- */\n.message-bubble.user .content::before { ${beforeStyle} }\n.message-bubble.user .content { ${userPaddingStyle} }\n`;
                        break;
                    case 'center':
                        aiCss = `\n/* --- AI气泡 (左侧/接收方 - 居中模板) --- */\n.message-bubble.ai .content::before { ${beforeStyle} }\n.message-bubble.ai .content { ${aiPaddingStyle} }\n`;
                        userCss = `\n/* --- 用户气泡 (右侧/发送方 - 居中模板) --- */\n.message-bubble.user .content::before { ${beforeStyle} }\n.message-bubble.user .content { ${userPaddingStyle} }\n`;
                        break;
                }
            }

            let finalCss = '', fileName = `${bubbleName.trim()}-EPhone-Style`, title = '';
            
            if (target === 'ai') {
                finalCss = header + baseRules + aiCss;
                fileName += '-AI.txt';
                title = 'Ephone AI 样式';
            } else if (target === 'user') {
                finalCss = header + baseRules + userCss;
                fileName += '-User.txt';
                title = 'Ephone User 样式';
            } else { // 'full'
                finalCss = header + baseRules + aiCss + userCss;
                fileName += '-合并.txt';
                title = 'Ephone 合并样式';
            }
            return { css: finalCss, fileName, title };
        }
        
        // =========================================================================
        // ======================== END: CORRECTED CODE BLOCK ========================
        // =========================================================================

        function downloadFile(content, fileName, contentType) {
            const blob = new Blob([content], { type: contentType }); 
            const link = document.createElement('a');
            link.download = fileName; 
            link.href = URL.createObjectURL(blob); 
            link.click(); 
            URL.revokeObjectURL(link.href); 
        }

        init();
        window.addEventListener('resize', redrawAll);
    });
    </script>
</body>
</html>
